 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/full_current_game b/full_current_game
index 2848176c6fc34da1d1bd7c05ec32556af6ec6357..5034f26009d555410a8d881ed01ad83be3497f0c 100644
--- a/full_current_game
+++ b/full_current_game
@@ -1,79 +1,85 @@
 define t = Character("Test-chan", color="#030e9f")
 
 image testchan neutral = "images/testchan_neutral.png"
 image testchan amused-smile   = "images/testchan_amused-smile.png"
 image testchan annoyed = "images/testchan_annoyed.png"
 image testchan happy-blush   = "images/testchan_happy-blush.png"
 image testchan embarrassed-blush   = "images/testchan_embarrassed-blush.png"
 
 transform tc_base:
     xalign 0.5
     yalign -0.05
     zoom 0.80
 
 default affection = 0
 default ai_busy = False
 default ai_result = {"reply":"", "affection_delta":0, "expression":"neutral", "tag":"other"}
 default vn_state = {
     "lane": "unknown",
     "affection": 0,
     "choices": []
 }
 default scene_id = "scene_1"
 default scene_log = []      # word-for-word lines for the current scene
 default archive_log = []    # list of past scenes (each is a dict)
+default choice_log = []     # list of choice effects for the current scene
 
 
 screen thinking_overlay():
     if ai_busy:
         frame:
             xalign 0.5
             yalign 0.5
             text "Test-chan is thinking..."
 
 init python:
     import os
     import json
     import urllib.request
 
     def log_line(kind, text):
         # kind: "CHOICE", "PLAYER", "TC" (Test-chan), "SYSTEM"
         scene_log.append({"kind": kind, "text": text})
 
-    def archive_scene():
+    def log_choice(text, delta):
+        choice_log.append({"text": text, "delta": delta})
+        log_line("CHOICE", text)
+
+    def archive_scene(summary_text=""):
         # Copy current scene log into an archive record
         archive_log.append({
             "scene_id": scene_id,
             "affection_end": affection,
             "lane": vn_state.get("lane", "unknown"),
             "transcript": list(scene_log),  # copy
-            "summary": "",
+            "summary": summary_text,
             "tags": []
         })
         # Clear for next scene
         scene_log[:] = []
+        choice_log[:] = []
 
     # Use a cert bundle you placed at game/cacert.pem
     os.environ["SSL_CERT_FILE"] = renpy.loader.transfn("cacert.pem")
 
     def load_openai_key():
         try:
             with renpy.open_file("openai_key.txt") as f:
                 key = f.read()
 
             if isinstance(key, bytes):
                 key = key.decode("utf-8", errors="ignore")
 
             key = key.strip()
             return key if key else None
 
         except urllib.error.HTTPError as e:
             body = e.read()
             try:
                 body = body.decode("utf-8", errors="ignore")
             except Exception:
                 pass
             renpy.log("OpenAI HTTPError {} body={}".format(e.code, body))
             return {"reply": "Request failed: HTTP {} (see log.txt)".format(e.code),
                     "affection_delta": 0, "expression": "neutral", "tag": "error"}
         except Exception as e:
@@ -144,57 +150,57 @@ init python:
             delta = 0
         if delta < -2: delta = -2
         if delta > 2:  delta = 2
 
         allowed_expr = {"neutral", "amused-smile", "annoyed", "happy-blush", "embarrassed-blush"}
         if expr not in allowed_expr:
             expr = "neutral"
 
         return {"reply": reply, "affection_delta": delta, "expression": expr, "tag": tag}
 
 
 label start:
     scene bg room
     show testchan neutral at tc_base
 
     t "Oh. Hey."
     t "You’re actually here."
 
     menu:
         "How do you respond?"
         "Be casual":
             $ lane = "casual"
             $ affection += 1
             $ vn_state["lane"] = "casual"
             $ vn_state["choices"].append("Responded casually")
-            $ log_line("CHOICE", "Be casual")
+            $ log_choice("Be casual", 1)
         "Be awkward":
             $ lane = "awkward"
             $ affection -= 1
             $ vn_state["lane"] = "awkward"
             $ vn_state["choices"].append("Responded awkwardly")
-            $ log_line("CHOICE", "Be awkward")
+            $ log_choice("Be awkward", -1)
 
     if lane == "casual":
         show testchan amused-smile at tc_base
         t "Wow. Confident. I respect that."
     else:
         show testchan annoyed at tc_base
         t "…Okay, that was a choice."
 
     show testchan neutral at tc_base
     t "So. Why did you come over?"
 
 label typed_input:
     $ player_message = renpy.input("Type what you say. (One sentence.)", length=120)
     $ player_message = player_message.strip()
     $ log_line("PLAYER", player_message)
 
     if not player_message:
         show testchan amused-smile at tc_base
         t "Cat got your tongue?"
         jump typed_input
 
 
     # --- compact game state for the AI ---
     $ recent = vn_state["choices"][-5:]
     $ state_blob = "LANE=" + vn_state["lane"] + "\n" + \
@@ -236,26 +242,36 @@ No extra keys. No markdown. No backticks."""
 
         renpy.invoke_in_thread(_worker)
 
     $ waited = 0.0
     while ai_busy and waited < 20.0:
         $ renpy.pause(0.1)
         $ waited += 0.1
 
     hide screen thinking_overlay
 
     if waited >= 20.0 and ai_busy:
         $ ai_busy = False
         t "Tch… your internet’s being dumb. Try again."
         jump typed_input
 
     # Apply AI result
     show expression "testchan " + ai_result["expression"] at tc_base
     $ affection += ai_result["affection_delta"]
     t "[ai_result['reply']]"
     $ log_line("TC", ai_result["reply"])
 
 
     show testchan neutral at tc_base
     t "Affection: [affection]"
 
+    python:
+        summary_lines = []
+        for entry in choice_log:
+            summary_lines.append("{} ({:+d} affection)".format(entry["text"], entry["delta"]))
+        summary_text = "Summary: " + "; ".join(summary_lines) + ". Total affection: {}.".format(affection)
+
+    $ log_line("SYSTEM", summary_text)
+    narrator "[summary_text]"
+    $ archive_scene(summary_text)
+
     return
 
EOF
)
